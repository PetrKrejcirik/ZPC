#define MODE_TRACK false
#define MODE_RPM true

const int Stepper_STEP = 4;
const int Stepper_DIR = 5;
const int Stepper_ENAB = 6;

const int Stepper_POT = A0;
const int Stepper_MODE_PIN = 3;

const int Stepper_MAXRPM = 200;
const int Stepper_TrackRPM = 100;
const long StepperPOS_MAX = 360;

bool StepperEnablePositioning = true;
bool StepperMode;
bool StepperPulse = false;

int StepperRPM;
long StepperPOSTarget;
long StepperPulseTarget;
long StepperPOSActual = 0;

int PotValue;
long PulsePeriod;
long PulseCounter = 0;

const int DriverMicrostep = 800;

unsigned long timestamp;
unsigned long LastTS = 0;

void setup() {
  pinMode(Stepper_STEP, OUTPUT);
  pinMode(Stepper_DIR, OUTPUT);
  pinMode(Stepper_ENAB, OUTPUT);
  pinMode(Stepper_POT, INPUT);
  pinMode(Stepper_MODE_PIN, INPUT);

  digitalWrite(Stepper_ENAB, LOW); // aktivovat driver
}

void loop() {
  timestamp = micros();
  PotValue = analogRead(Stepper_POT);
  StepperMode = digitalRead(Stepper_MODE_PIN);

  if (StepperMode == MODE_RPM) {
    StepperRPM = map(PotValue, 0, 1023, 0, Stepper_MAXRPM);
    if (PotValue > 512) digitalWrite(Stepper_DIR, HIGH);
    else digitalWrite(Stepper_DIR, LOW);
  } 
  else {
    StepperRPM = Stepper_TrackRPM;
    StepperPOSTarget = map(PotValue, 0, 1023, 0, StepperPOS_MAX);
    StepperPulseTarget = long((float(StepperPOSTarget) / 360) * float(DriverMicrostep));

    if (StepperPOSTarget > StepperPOSActual)
      digitalWrite(Stepper_DIR, HIGH);
    else
      digitalWrite(Stepper_DIR, LOW);
  }

  if (StepperRPM > 0 && StepperEnablePositioning) {
    PulsePeriod = long(float(60 * 1000000) / float(StepperRPM * DriverMicrostep));

    if (timestamp - LastTS >= PulsePeriod) {
      LastTS = timestamp;

      if (!StepperPulse) {
        digitalWrite(Stepper_STEP, HIGH);
        if (StepperMode == MODE_TRACK) {
          PulseCounter++;
          if (digitalRead(Stepper_DIR) == HIGH) StepperPOSActual++;
          else StepperPOSActual--;
        }
      } else {
        digitalWrite(Stepper_STEP, LOW);
      }

      StepperPulse = !StepperPulse;
    }
  }

  if (StepperMode == MODE_TRACK && abs(StepperPOSTarget - StepperPOSActual) < 1) {
    StepperEnablePositioning = false;
  } else {
    StepperEnablePositioning = true;
  }
}
